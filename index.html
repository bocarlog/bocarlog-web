<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë³´ì¹´ë¡œê·¸ v1.6</title>
    <style>
        :root { --gold: #FFD700; --dark: #1a1a1a; }
        body { font-family: sans-serif; background: #f8f9fa; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; width: 100%; max-width: 400px; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 25px; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        .btn-submit { width: 100%; padding: 16px; background: var(--dark); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 17px; cursor: pointer; margin-top: 15px; }
        #status { margin-top: 20px; text-align: center; font-size: 14px; font-weight: bold; white-space: pre-line; line-height: 1.6; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>BOCARLOG v1.6</h2>
            <p style="color: #666; font-size: 14px;">ë³´ì•ˆ ê²€ì—´ì„ ìš°íšŒí•˜ì—¬ ì§ì ‘ ì „ì†¡í•©ë‹ˆë‹¤.</p>
        </div>
        
        <input type="email" id="email" placeholder="ì´ë©”ì¼ ì£¼ì†Œ">
        <input type="text" id="carNumber" placeholder="ì°¨ëŸ‰ë²ˆí˜¸">
        <input type="number" id="mileage" placeholder="ì£¼í–‰ê±°ë¦¬ (km)">
        <input type="file" id="files" multiple accept="image/*">
        
        <button type="button" class="btn-submit" onclick="directUpload()">ì—…ë¡œë“œ ì‹œì‘</button>
        
        <div id="status">ìƒíƒœ: ëŒ€ê¸° ì¤‘</div>
    </div>

    <script>
        async function directUpload() {
            const statusDiv = document.getElementById('status');
            const URL = 'https://zcwcmhrvxdwgzbzwyqty.supabase.co';
            const KEY = 'sb_publishable_EDxa41-p5HGoU_F4PatQlA_VsAdk3-F';

            const email = document.getElementById('email').value.trim();
            const carNumber = document.getElementById('carNumber').value.trim();
            const mileage = document.getElementById('mileage').value;
            const fileInput = document.getElementById('files');

            if (!email || !carNumber || fileInput.files.length === 0) {
                alert("í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•˜ê³  ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            statusDiv.innerHTML = "â³ [1/3] ì„œë²„ ë³´ì•ˆ ë²½ í†µê³¼ ì‹œë„ ì¤‘...";
            statusDiv.style.color = "orange";

            try {
                // 1. ì°¨ëŸ‰ ì •ë³´ ë“±ë¡ (PostgREST API ì§ì ‘ í˜¸ì¶œ)
                const vResponse = await fetch(`${URL}/rest/v1/vehicles`, {
                    method: 'POST',
                    headers: {
                        'apikey': KEY,
                        'Authorization': `Bearer ${KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        owner_email: email,
                        car_number: carNumber,
                        current_mileage: parseInt(mileage)
                    })
                });

                if (!vResponse.ok) {
                    const errorDetail = await vResponse.text();
                    throw new Error(`ì°¨ëŸ‰ ë“±ë¡ ì‹¤íŒ¨: ${errorDetail}`);
                }

                const vData = await vResponse.json();
                const vehicleId = vData[0].id;
                statusDiv.innerHTML = "âœ… [2/3] ì„œë²„ ìŠ¹ì¸ ì™„ë£Œ! ì‚¬ì§„ ì „ì†¡ ì¤‘...";

                // 2. ì‚¬ì§„ ì—…ë¡œë“œ ë° ë¡œê·¸ ê¸°ë¡
                for (let i = 0; i < fileInput.files.length; i++) {
                    const file = fileInput.files[i];
                    const fileName = `${vehicleId}/${Date.now()}_${i}.jpg`;
                    
                    // ìŠ¤í† ë¦¬ì§€ ì§ì ‘ ì—…ë¡œë“œ
                    const sResponse = await fetch(`${URL}/storage/v1/object/receipts/${fileName}`, {
                        method: 'POST',
                        headers: {
                            'apikey': KEY,
                            'Authorization': `Bearer ${KEY}`,
                            'Content-Type': file.type
                        },
                        body: file
                    });

                    if (!sResponse.ok) throw new Error("ì‚¬ì§„ ì €ì¥ì†Œ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.");

                    // ë¡œê·¸ í…Œì´ë¸” ì§ì ‘ ê¸°ë¡
                    await fetch(`${URL}/rest/v1/maintenance_logs`, {
                        method: 'POST',
                        headers: {
                            'apikey': KEY,
                            'Authorization': `Bearer ${KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            vehicle_id: vehicleId,
                            image_url: fileName
                        })
                    });
                    
                    statusDiv.innerHTML = `â³ [3/3] ì‚¬ì§„ ì „ì†¡ ì¤‘... (${i+1}/${fileInput.files.length})`;
                }

                statusDiv.innerHTML = "ğŸ‰ ì„±ê³µ! ëª¨ë“  ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\nê³ ìƒí•˜ì…¨ìŠµë‹ˆë‹¤ ëŒ€í‘œë‹˜!";
                statusDiv.style.color = "green";

            } catch (err) {
                console.error("ìµœì¢… ì—ëŸ¬ ìƒì„¸:", err);
                statusDiv.innerHTML = "âŒ í†µì‹  ì°¨ë‹¨ë¨\n" + err.message;
                statusDiv.style.color = "red";
            }
        }
    </script>
</body>
</html>
