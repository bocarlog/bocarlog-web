<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë³´ì¹´ë¡œê·¸ ê´€ë¦¬ ì¸ì¦</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root { --gold: #FFD700; --dark: #1a1a1a; --gray: #888; }
        body { font-family: -apple-system, sans-serif; background-color: #f8f9fa; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; width: 100%; max-width: 480px; padding: 30px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .header { text-align: center; margin-bottom: 30px; }
        .logo { font-size: 24px; font-weight: 900; color: var(--dark); }
        label { font-size: 14px; font-weight: 600; display: block; margin: 20px 0 8px; }
        input { width: 100%; padding: 14px; border: 1px solid #eee; border-radius: 12px; box-sizing: border-box; font-size: 16px; background: #fafafa; }
        .upload-area { border: 2px dashed var(--gold); padding: 30px; text-align: center; border-radius: 16px; cursor: pointer; }
        
        /* ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ ìŠ¤íƒ€ì¼ */
        #preview-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .preview-img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; }
        
        .btn-submit { width: 100%; padding: 18px; background: var(--dark); color: white; border: none; border-radius: 16px; font-weight: bold; font-size: 17px; margin-top: 30px; cursor: pointer; }
        #status { margin-top: 20px; text-align: center; font-size: 14px; white-space: pre-line; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">BOCARLOG</div>
            <p style="color:#666; font-size:14px; margin-top:10px;">ì •ì„± ë“¤ì—¬ ê´€ë¦¬í•œ ë‚´ ì°¨,<br>ì¸ì¦ ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.</p>
        </div>
        
        <label>ì´ë©”ì¼ ì£¼ì†Œ</label>
        <input type="email" id="email" placeholder="example@email.com">
        
        <label>ì°¨ëŸ‰ë²ˆí˜¸</label>
        <input type="text" id="carNumber" placeholder="ì˜ˆ: 12ê°€ 3456">
        
        <label>í˜„ì¬ ì£¼í–‰ê±°ë¦¬ (km)</label>
        <input type="number" id="mileage" placeholder="ì˜ˆ: 45000">

        <label>ì •ë¹„ ë‚´ì—­ì„œ / ì˜ìˆ˜ì¦ ì‚¬ì§„</label>
        <div class="upload-area" onclick="document.getElementById('files').click()">
            <span style="font-size: 30px;">ğŸ“¸</span><br>
            <span id="fileLabel" style="font-size: 14px; color: var(--gray);">ì‚¬ì§„ì„ ì„ íƒí•˜ê±°ë‚˜ ì´¬ì˜í•˜ì„¸ìš”</span>
            <input type="file" id="files" multiple accept="image/*" style="display:none" onchange="handleFileSelect(event)">
        </div>

        <div id="preview-container"></div>

        <button class="btn-submit" onclick="handleUpload()">ì—…ë¡œë“œ</button>
        <div id="status"></div>
    </div>

    <script>
        // ì´ˆê¸°í™” ìˆœì„œë¥¼ ì—„ê²©íˆ ì§€í‚µë‹ˆë‹¤.
        const SUPABASE_URL = 'ëŒ€í‘œë‹˜ì˜_PROJECT_URL';
        const SUPABASE_KEY = 'ëŒ€í‘œë‹˜ì˜_ANON_KEY';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ì‚¬ì§„ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸° ìƒì„± í•¨ìˆ˜
        function handleFileSelect(event) {
            const files = event.target.files;
            const container = document.getElementById('preview-container');
            const label = document.getElementById('fileLabel');
            container.innerHTML = ''; // ê¸°ì¡´ ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”

            if (files.length > 0) {
                label.innerText = `${files.length}ì¥ì˜ ì‚¬ì§„ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤`;
                
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'preview-img';
                        container.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                });
            }
        }

        async function handleUpload() {
            const email = document.getElementById('email').value.trim();
            const carNumber = document.getElementById('carNumber').value.trim();
            const mileage = document.getElementById('mileage').value.trim();
            const files = document.getElementById('files').files;
            const statusDiv = document.getElementById('status');

            if (!email || !carNumber || files.length === 0) {
                alert("ì´ë©”ì¼, ì°¨ëŸ‰ë²ˆí˜¸, ì‚¬ì§„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤!");
                return;
            }

            statusDiv.innerHTML = "â³ <b>ì—…ë¡œë“œ ì¤‘...</b>\nì‚¬ì§„ ìš©ëŸ‰ì— ë”°ë¼ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
            statusDiv.style.color = "#f39c12";

            try {
                // 1. ì°¨ëŸ‰ ì •ë³´ ë“±ë¡ (upsert)
                const { data: vData, error: vError } = await supabaseClient
                    .from('vehicles')
                    .upsert({ owner_email: email, car_number: carNumber, current_mileage: mileage }, { onConflict: 'owner_email' })
                    .select().single();

                if (vError) throw vError;

                // 2. íŒŒì¼ ìŠ¤í† ë¦¬ì§€ ì—…ë¡œë“œ ë° ë¡œê·¸ ìƒì„±
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileName = `${vData.id}/${Date.now()}_${i}.jpg`;

                    const { error: sError } = await supabaseClient.storage
                        .from('receipts')
                        .upload(fileName, file);
                    if (sError) throw sError;

                    const { error: lError } = await supabaseClient
                        .from('maintenance_logs')
                        .insert({ vehicle_id: vData.id, image_url: fileName });
                    if (lError) throw
