<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë³´ì¹´ë¡œê·¸ ê´€ë¦¬ ì¸ì¦</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root { --gold: #FFD700; --dark: #1a1a1a; --gray: #888; }
        body { font-family: -apple-system, sans-serif; background-color: #f8f9fa; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; width: 100%; max-width: 480px; padding: 30px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .header { text-align: center; margin-bottom: 30px; }
        .logo { font-size: 24px; font-weight: 900; color: var(--dark); margin: 0; }
        label { font-size: 14px; font-weight: 600; display: block; margin: 20px 0 8px; }
        input { width: 100%; padding: 14px; border: 1px solid #eee; border-radius: 12px; box-sizing: border-box; font-size: 16px; background: #fafafa; }
        .upload-area { border: 2px dashed var(--gold); padding: 30px; text-align: center; border-radius: 16px; cursor: pointer; }
        #preview-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .preview-img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; }
        .btn-submit { width: 100%; padding: 18px; background: var(--dark); color: white; border: none; border-radius: 16px; font-weight: bold; font-size: 17px; margin-top: 30px; cursor: pointer; }
        #status { margin-top: 20px; text-align: center; font-size: 14px; white-space: pre-line; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="logo">BOCARLOG</h1>
            <p style="color:#666; font-size:14px; margin-top:10px;">ì •ì„± ë“¤ì—¬ ê´€ë¦¬í•œ ë‚´ ì°¨,<br>ì¸ì¦ ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.</p>
        </div>
        
        <label>ì´ë©”ì¼ ì£¼ì†Œ</label>
        <input type="email" id="email" placeholder="example@email.com">
        <label>ì°¨ëŸ‰ë²ˆí˜¸</label>
        <input type="text" id="carNumber" placeholder="ì˜ˆ: 38ë²„ 2400">
        <label>í˜„ì¬ ì£¼í–‰ê±°ë¦¬ (km)</label>
        <input type="number" id="mileage" placeholder="ì˜ˆ: 10112">

        <label>ì •ë¹„ ë‚´ì—­ì„œ / ì˜ìˆ˜ì¦ ì‚¬ì§„</label>
        <div class="upload-area" onclick="document.getElementById('files').click()">
            <span style="font-size: 30px;">ğŸ“¸</span><br>
            <span id="fileLabel" style="font-size: 14px; color: var(--gray);">ì‚¬ì§„ì„ ì„ íƒí•˜ê±°ë‚˜ ì´¬ì˜í•˜ì„¸ìš”</span>
            <input type="file" id="files" multiple accept="image/*" style="display:none" onchange="handleFileSelect(event)">
        </div>
        <div id="preview-container"></div>

        <button class="btn-submit" onclick="handleUpload()">ì—…ë¡œë“œ</button>
        <div id="status"></div>
    </div>

    <script>
        // ë³€ìˆ˜ ì„ ì–¸ì„ í•¨ìˆ˜ ë°–ì—ì„œ ë¯¸ë¦¬ í•´ë‘¡ë‹ˆë‹¤.
        // ì´ ë‘ ì¤„ì„ ê¸°ì¡´ ì½”ë“œ ìœ„ì— ê·¸ëŒ€ë¡œ ë®ì–´ì“°ê¸° í•˜ì„¸ìš”.
        const URL = 'https://zcwcmhrvxdwgzbzwyqty.supabase.co';
        const KEY = 'sb_publishable_EDxa41-p5HGoU_F4PatQlA_VsAdk3-F';
        // ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜ (ì´ë¯¸ ì˜ ì‘ë™ ì¤‘!)
        // ğŸ’¡ í•¨ìˆ˜ ë°–ì—ì„œ ë¯¸ë¦¬ í´ë¼ì´ì–¸íŠ¸ë¥¼ ë§Œë“¤ì–´ë²„ë¦½ë‹ˆë‹¤.
        const supabaseClient = supabase.createClient(URL, KEY);
        
        function handleFileSelect(event) {
            const files = event.target.files;
            const container = document.getElementById('preview-container');
            const label = document.getElementById('fileLabel');
            container.innerHTML = ''; 
            if (files.length > 0) {
                label.innerText = `${files.length}ì¥ì˜ ì‚¬ì§„ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤`;
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'preview-img';
                        container.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                });
            }
        }

        // ì—…ë¡œë“œ í•¨ìˆ˜ (ì—ëŸ¬ ì™„ë²½ ì°¨ë‹¨ ë²„ì „)
        async function handleUpload() {
            const statusDiv = document.getElementById('status');
            try {
                // ì´ˆê¸°í™”ê°€ ì•ˆ ë˜ì–´ ìˆë‹¤ë©´ ì—¬ê¸°ì„œ ìˆ˜í–‰
                const email = document.getElementById('email').value.trim();
                const carNumber = document.getElementById('carNumber').value.trim();
                const mileage = document.getElementById('mileage').value.trim();
                const files = document.getElementById('files').files;

                if (!email || !carNumber || files.length === 0) {
                    alert("ì´ë©”ì¼, ì°¨ëŸ‰ë²ˆí˜¸, ì‚¬ì§„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤!");
                    return;
                }

                statusDiv.innerHTML = "â³ ì—…ë¡œë“œ ì¤‘...";
                statusDiv.style.color = "#f39c12";

                // 1. ì°¨ëŸ‰ ì •ë³´ ì €ì¥
                const { data: vData, error: vError } = await supabaseClient
                    .from('vehicles')
                    .upsert({ owner_email: email, car_number: carNumber, current_mileage: mileage }, { onConflict: 'owner_email' })
                    .select().single();
                if (vError) throw vError;

                // 2. ì´ë¯¸ì§€ ì—…ë¡œë“œ
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileName = `${vData.id}/${Date.now()}_${i}.jpg`;
                    const { error: sError } = await supabaseClient.storage.from('receipts').upload(fileName, file);
                    if (sError) throw sError;

                    await supabaseClient.from('maintenance_logs').insert({ vehicle_id: vData.id, image_url: fileName });
                }

                statusDiv.innerHTML = "âœ… ì—…ë¡œë“œ ì„±ê³µ!\në°ì´í„°ê°€ ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.";
                statusDiv.style.color = "#27ae60";
            } catch (err) {
                statusDiv.innerHTML = "âŒ ì˜¤ë¥˜ ë°œìƒ: " + err.message;
                statusDiv.style.color = "#e74c3c";
            }
        }
    </script>
</body>
</html>




