<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë³´ì¹´ë¡œê·¸ ê´€ë¦¬ ì¸ì¦ | ë‚´ ì°¨ì˜ ê°€ì¹˜ë¥¼ ìˆ«ìë¡œ</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root { --gold: #FFD700; --dark: #1a1a1a; --gray: #888; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f8f9fa; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; width: 100%; max-width: 480px; padding: 30px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .header { text-align: center; margin-bottom: 30px; }
        .logo { font-size: 24px; font-weight: 900; color: var(--dark); letter-spacing: -1px; }
        .badge { background: var(--gold); display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; margin-top: 8px; }
        label { font-size: 14px; font-weight: 600; color: var(--dark); display: block; margin-bottom: 8px; margin-top: 20px; }
        input { width: 100%; padding: 14px; border: 1px solid #eee; border-radius: 12px; box-sizing: border-box; font-size: 16px; background: #fafafa; }
        input:focus { outline: 2px solid var(--gold); background: white; }
        .upload-area { border: 2px dashed #ddd; padding: 40px 20px; text-align: center; border-radius: 16px; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .upload-area:active { background: #fffdf0; border-color: var(--gold); }
        .upload-icon { font-size: 30px; margin-bottom: 10px; display: block; }
        .upload-text { font-size: 14px; color: var(--gray); }
        .btn-submit { width: 100%; padding: 18px; background: var(--dark); color: white; border: none; border-radius: 16px; font-weight: bold; font-size: 17px; margin-top: 30px; cursor: pointer; }
        #status { margin-top: 20px; text-align: center; font-size: 14px; line-height: 1.5; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">BOCARLOG</div>
            <div class="badge">ê´€ë¦¬ ì¸ì¦ ì„œë¹„ìŠ¤ 1ê¸°</div>
            <p style="color:#666; font-size:14px; margin-top:15px;">ì •ì„± ë“¤ì—¬ ê´€ë¦¬í•œ ë‚´ ì°¨,<br>ìˆ«ìë¡œ ê°€ì¹˜ë¥¼ ì¦ëª…í•˜ì„¸ìš”.</p>
        </div>
        
        <label>ì´ë©”ì¼ ì£¼ì†Œ</label>
        <input type="email" id="email" placeholder="ê²°ê³¼ë¥¼ ë°›ìœ¼ì‹¤ ì´ë©”ì¼">
        
        <label>ì°¨ëŸ‰ë²ˆí˜¸</label>
        <input type="text" id="carNumber" placeholder="ì˜ˆ: 123ê°€ 4567">
        
        <label>í˜„ì¬ ì£¼í–‰ê±°ë¦¬ (km)</label>
        <input type="number" id="mileage" placeholder="ì˜ˆ: 45000">

        <label>ì •ë¹„ ë‚´ì—­ì„œ / ì˜ìˆ˜ì¦ ì‚¬ì§„</label>
        <div class="upload-area" onclick="document.getElementById('files').click()">
            <span class="upload-icon">ğŸ“¸</span>
            <span id="fileLabel" class="upload-text">ì—¬ëŸ¬ ì¥ì„ í•œêº¼ë²ˆì— ì˜¬ë¦´ ìˆ˜ ìˆì–´ìš”</span>
            <input type="file" id="files" multiple accept="image/*" style="display:none" onchange="updateFileLabel()">
        </div>

        <button class="btn-submit" onclick="handleUpload()">ê°€ì¹˜ ì¸¡ì • ì‹œì‘í•˜ê¸°</button>
        <div id="status"></div>
    </div>

    <script>
        // ë³´ì¹´ë¡œê·¸ í”„ë¡œì íŠ¸ ì •ë³´ (ì‹¤ì œ ê°’ìœ¼ë¡œ ê¼­ ë³€ê²½í•˜ì„¸ìš”!)
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function updateFileLabel() {
            const count = document.getElementById('files').files.length;
            document.getElementById('fileLabel').innerText = count > 0 ? `${count}ì¥ì˜ ì‚¬ì§„ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤` : "ì—¬ëŸ¬ ì¥ì„ í•œêº¼ë²ˆì— ì˜¬ë¦´ ìˆ˜ ìˆì–´ìš”";
        }

        async function handleUpload() {
            const email = document.getElementById('email').value.trim();
            const carNumber = document.getElementById('carNumber').value.trim();
            const mileage = document.getElementById('mileage').value.trim();
            const files = document.getElementById('files').files;
            const statusDiv = document.getElementById('status');

            if (!email || !carNumber || files.length === 0) {
                alert("ì´ë©”ì¼, ì°¨ëŸ‰ë²ˆí˜¸, ì‚¬ì§„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤!");
                return;
            }

            statusDiv.innerHTML = "â³ <b>ë°ì´í„° ë¶„ì„ ë° ì—…ë¡œë“œ ì¤‘...</b><br>ì‚¬ì§„ ìš©ëŸ‰ì— ë”°ë¼ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
            statusDiv.style.color = "#f39c12";

            try {
                // 1. ì°¨ëŸ‰ ì •ë³´ ë“±ë¡
                const { data: vData, error: vError } = await supabaseClient
                    .from('vehicles')
                    .upsert({ owner_email: email, car_number: carNumber, current_mileage: mileage }, { onConflict: 'owner_email' })
                    .select().single();

                if (vError) throw vError;

                // 2. ì´ë¯¸ì§€ ì—…ë¡œë“œ
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileName = `${vData.id}/${Date.now()}_${i}.jpg`;

                    const { error: sError } = await supabaseClient.storage
                        .from('receipts')
                        .upload(fileName, file);

                    if (sError) throw sError;

                    const { error: lError } = await supabaseClient
                        .from('maintenance_logs')
                        .insert({ vehicle_id: vData.id, image_url: fileName });

                    if (lError) throw lError;
                }

                statusDiv.innerHTML = "âœ… <b>ì „ì†¡ ì„±ê³µ!</b><br>ë³´ì¹´ë¡œê·¸ê°€ ì •ì„±ê» ë¶„ì„í•˜ì—¬ ë¦¬í¬íŠ¸ë¥¼ ë³´ë‚´ë“œë¦´ê²Œìš”.";
                statusDiv.style.color = "#27ae60";
            } catch (err) {
                console.error(err);
                statusDiv.innerHTML = "âŒ <b>ì˜¤ë¥˜ ë°œìƒ</b><br>" + err.message;
                statusDiv.style.color = "#e74c3c";
            }
        }
    </script>
</body>
</html>